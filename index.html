<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Cardápio e Pedidos</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .lucide-icon { display: inline-block; width: 1.25em; height: 1.25em; vertical-align: middle; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/jsx">
    const { useState, useEffect, createContext, useContext } = React;
    const { createClient } = supabase;

    // Configuração do Supabase (Substitua estes valores)
    const supabaseUrl = "https://your-project-id.supabase.co";
    const supabaseAnonKey = "your-anon-key";
    const client = createClient(supabaseUrl, supabaseAnonKey);

    // Componentes de mock para UI
    const Toaster = () => <div className="fixed bottom-4 right-4 z-[9999] p-4 text-white bg-green-500 rounded-md shadow-lg">Toast Mock</div>;
    const Sonner = () => <div className="fixed bottom-4 left-4 z-[9999] p-4 text-white bg-blue-500 rounded-md shadow-lg">Sonner Mock</div>;
    const TooltipProvider = ({ children }) => <>{children}</>;
    const Skeleton = ({ className }) => <div className={`bg-gray-300 rounded-lg ${className}`}></div>;
    const Button = ({ className, onClick, children }) => <button className={`p-4 rounded-md ${className}`} onClick={onClick}>{children}</button>;
    const Badge = ({ children, className }) => <span className={`px-2 py-1 text-xs font-bold rounded-full ${className}`}>{children}</span>;

    const AppLayout = ({ children }) => (
      <div className="min-h-screen bg-gray-100 font-sans antialiased">
        <div className="pt-16 pb-20">
          {children}
        </div>
      </div>
    );

    // Contexto de Autenticação
    const AuthContext = createContext(null);
    const AuthProvider = ({ children }) => {
      const [currentUser, setCurrentUser] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [loading, setLoading] = useState(true);

      const authService = {
        signUp: async (email, password) => client.auth.signUp({ email, password }),
        signIn: async (email, password) => client.auth.signInWithPassword({ email, password }),
        logOut: async () => client.auth.signOut(),
      };

      useEffect(() => {
        const { data: authListener } = client.auth.onAuthStateChange(
          async (event, session) => {
            setLoading(true);
            const supabaseUser = session?.user || null;
            if (supabaseUser) {
              const { data, error } = await client
                .from("usuarios")
                .select("role, empresa_id, name, phone, cep, street, number, complement, neighborhood, city, state")
                .eq("id", supabaseUser.id)
                .single();
              if (data) {
                const updatedUser = {
                  ...supabaseUser,
                  role: data.role,
                  empresa_id: data.empresa_id,
                  name: data.name,
                  phone: data.phone,
                  address: {
                    cep: data.cep,
                    street: data.street,
                    number: data.number,
                    complement: data.complement,
                    neighborhood: data.neighborhood,
                    city: data.city,
                    state: data.state,
                  }
                };
                setCurrentUser(updatedUser);
                setUserRole(data.role);
              } else {
                setCurrentUser(supabaseUser);
                setUserRole(null);
                console.warn("AuthContext: Dados de perfil não encontrados para o usuário:", supabaseUser.id, error?.message);
              }
            } else {
              setCurrentUser(null);
              setUserRole(null);
            }
            setLoading(false);
          }
        );
        return () => {
          authListener.subscription.unsubscribe();
        };
      }, []);

      const value = {
        currentUser,
        userRole,
        loading,
        signUp: authService.signUp,
        signIn: authService.signIn,
        logOut: authService.logOut,
      };

      return (
        <AuthContext.Provider value={value}>
          {children}
        </AuthContext.Provider>
      );
    };

    const useAuth = () => {
      const context = useContext(AuthContext);
      if (!context) {
        throw new Error("useAuth must be used within an AuthProvider");
      }
      return context;
    };

    // Contexto do Carrinho
    const CartContext = createContext(null);
    const CartProvider = ({ children }) => {
      const [cart, setCart] = useState([]);
      const [isCartOpen, setIsCartOpen] = useState(false);
      const addItem = (item) => setCart((prev) => [...prev, item]);
      const removeItem = (itemId) => setCart((prev) => prev.filter((i) => i.id !== itemId));
      const clearCart = () => setCart([]);
      const itemCount = cart.length;
      const totalPrice = cart.reduce((total, item) => total + item.price, 0);
      const value = {
        cart,
        itemCount,
        totalPrice,
        isCartOpen,
        setIsCartOpen,
        addItem,
        removeItem,
        clearCart,
      };
      return <CartContext.Provider value={value}>{children}</CartContext.Provider>;
    };

    const useCart = () => {
      const context = useContext(CartContext);
      if (context === undefined) {
        throw new Error("useCart deve ser usado dentro de um CartProvider");
      }
      return context;
    };

    // Componente de Ícone do Carrinho
    const ShoppingCartIcon = () => {
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart">
          <circle cx="8" cy="21" r="1" />
          <circle cx="19" cy="21" r="1" />
          <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12" />
        </svg>
      );
    };

    // Componentes de Página
    const Index = ({ slug }) => {
      const [menuItems, setMenuItems] = useState([]);
      const [categories, setCategories] = useState([]);
      const [activeCategory, setActiveCategory] = useState("all");
      const [isLoading, setIsLoading] = useState(true);
      const { itemCount, setIsCartOpen } = useCart();
      const [empresaData, setEmpresaData] = useState(null);

      useEffect(() => {
        const loadData = async () => {
          if (!slug) {
            setIsLoading(false);
            return;
          }
          setIsLoading(true);
          try {
            const { data: empresa, error: empresaError } = await client
              .from('empresas')
              .select('id, nome, logo_url, cor_primaria, cor_secundaria')
              .eq('slug', slug)
              .single();

            if (empresaError || !empresa) {
              console.error('Empresa não encontrada:', empresaError?.message || 'Empresa com slug não encontrada.');
              setIsLoading(false);
              return;
            }
            setEmpresaData(empresa);
            const empresaId = empresa.id;

            const { data: categoriesData, error: categoriesError } = await client
              .from('categories')
              .select('id, name, display_order')
              .eq('empresa_id', empresaId)
              .order('display_order', { ascending: true });

            if (categoriesError) throw new Error(categoriesError.message);
            
            const formattedCategories = categoriesData.map(cat => ({ id: cat.id, name: cat.name, order: cat.display_order }));
            const categoriesWithAll = [{ id: "all", name: "Todos", order: 0 }, ...formattedCategories];
            setCategories(categoriesWithAll);

            const { data: menuItemsData, error: itemsError } = await client
              .from('menu_items')
              .select(`id, name, description, price, image_url, category_id`)
              .eq('empresa_id', empresaId);

            if (itemsError) throw new Error(itemsError.message);
            const formattedItems = menuItemsData.map(item => ({ ...item, category: item.category_id }));
            setMenuItems(formattedItems);

          } catch (err) {
            console.error('Erro ao carregar dados:', err);
          } finally {
            setIsLoading(false);
          }
        };

        loadData();
      }, [slug]);

      const filteredItems = activeCategory === "all"
        ? menuItems
        : menuItems.filter((item) => item.category === activeCategory);

      const groupedItems = categories.reduce((acc, category) => {
        if (category.id === "all") return acc;
        const categoryItems = filteredItems.filter((item) => item.category === category.id);
        if (categoryItems.length > 0) {
          acc.push({ category, items: categoryItems });
        }
        return acc;
      }, []);

      const RestaurantHeader = ({ nome, logo_url, cor_primaria, cor_secundaria }) => (
        <div className="relative">
          <div className="h-48 sm:h-64 w-full bg-cover bg-center" style={{ backgroundImage: `url(${logo_url})`, backgroundColor: cor_primaria }}></div>
          <div className="container mx-auto px-4 relative -mt-16 sm:-mt-24 z-10 mb-6">
            <div className="bg-white rounded-lg shadow-lg p-6 flex flex-col sm:flex-row items-center">
              <div className="w-24 h-24 rounded-full bg-gray-400 mr-0 sm:mr-6 mb-4 sm:mb-0" style={{ backgroundColor: cor_secundaria }}></div>
              <div className="text-center sm:text-left">
                <h1 className="text-2xl font-bold text-gray-800">{nome}</h1>
              </div>
            </div>
          </div>
        </div>
      );

      const CategoryNav = ({ categories, activeCategory, onSelectCategory }) => (
        <div className="sticky top-0 bg-white z-20 shadow-sm overflow-x-auto whitespace-nowrap px-4 py-2">
          <nav className="flex space-x-4">
            {categories.map((category) => (
              <Button
                key={category.id}
                onClick={() => onSelectCategory(category.id)}
                className={`flex-shrink-0 px-4 py-2 rounded-full font-medium ${activeCategory === category.id ? "bg-black text-white" : "bg-gray-200 text-gray-800"}`}
              >
                {category.name}
              </Button>
            ))}
          </nav>
        </div>
      );
      
      const MenuSection = ({ title, items }) => (
        <section id={title.toLowerCase().replace(/ /g, "-")} className="mb-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-4">{title}</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {items.map((item) => (
              <div key={item.id} className="bg-white rounded-lg shadow-md overflow-hidden flex">
                <div className="flex-1 p-4">
                  <h3 className="text-lg font-semibold text-gray-900">{item.name}</h3>
                  <p className="mt-1 text-sm text-gray-500">{item.description}</p>
                  <div className="mt-2 text-xl font-bold text-gray-800">R$ {item.price.toFixed(2)}</div>
                </div>
                {item.image_url && (
                  <img src={item.image_url} alt={item.name} className="w-24 h-24 object-cover flex-shrink-0" />
                )}
              </div>
            ))}
          </div>
        </section>
      );

      if (isLoading) {
        return (
          <div>
            <div className="relative animate-pulse">
              <div className="h-48 sm:h-64 w-full bg-gray-300"></div>
              <div className="container mx-auto px-4 relative -mt-16 sm:-mt-24 z-10 mb-6">
                <div className="bg-white rounded-lg shadow-lg p-6 flex flex-col sm:flex-row items-center">
                  <div className="w-24 h-24 rounded-full bg-gray-400 mr-0 sm:mr-6 mb-4 sm:mb-0"></div>
                  <div className="text-center sm:text-left">
                    <Skeleton className="h-6 w-48 mb-2" />
                    <Skeleton className="h-4 w-64" />
                  </div>
                </div>
              </div>
            </div>
            <div className="container mx-auto px-4 py-4 space-y-4">
              <Skeleton className="h-10 w-full" />
              <Skeleton className="h-64 w-full" />
              <Skeleton className="h-64 w-full" />
            </div>
          </div>
        );
      }

      if (!empresaData) {
        return (
          <div className="flex flex-col items-center justify-center min-h-screen text-center p-8">
            <h1 className="text-2xl font-bold text-gray-800">Oops! Empresa não encontrada.</h1>
            <p className="mt-2 text-gray-600">Verifique se o endereço está correto ou tente novamente mais tarde.</p>
          </div>
        );
      }
      
      return (
        <div>
          <RestaurantHeader {...empresaData} />
          <CategoryNav
            categories={categories}
            activeCategory={activeCategory}
            onSelectCategory={setActiveCategory}
          />
          <div className="container mx-auto px-4 py-8">
            {activeCategory === "all" ? (
              groupedItems.map(({ category, items }) => (
                <MenuSection
                  key={category.id}
                  title={category.name}
                  items={items}
                />
              ))
            ) : (
              <MenuSection
                title={categories.find((cat) => cat.id === activeCategory)?.name || "Menu"}
                items={filteredItems}
              />
            )}
          </div>
          {itemCount > 0 && (
            <div className="fixed bottom-4 left-0 right-0 z-50 flex justify-center px-4">
              <Button
                className="w-full max-w-sm rounded-full text-lg h-14 shadow-lg bg-black text-white"
                onClick={() => setIsCartOpen(true)}
              >
                <ShoppingCartIcon className="mr-2" />
                Ver Carrinho <Badge className="ml-2 bg-white text-black font-bold">({itemCount})</Badge>
              </Button>
            </div>
          )}
        </div>
      );
    };

    const Login = ({ navigate }) => <div>Login Page <button onClick={() => navigate('index', { slug: 'restaurante-teste' })}>Voltar</button></div>;
    const Register = ({ navigate }) => <div>Register Page <button onClick={() => navigate('index', { slug: 'restaurante-teste' })}>Voltar</button></div>;
    const Admin = ({ navigate }) => <div>Admin Page <button onClick={() => navigate('index', { slug: 'restaurante-teste' })}>Voltar</button></div>;
    const NotFound = ({ navigate }) => <div>404 Not Found <button onClick={() => navigate('index', { slug: 'restaurante-teste' })}>Voltar</button></div>;
    const ShoppingCart = () => <div>Shopping Cart Component</div>;

    const App = () => {
      const [page, setPage] = useState("index");
      const [params, setParams] = useState({ slug: 'restaurante-teste' });
      const navigate = (newPage, newParams = {}) => {
        setPage(newPage);
        setParams(newParams);
      };

      let content;
      switch (page) {
        case "index":
          content = <Index slug={params.slug} />;
          break;
        case "login":
          content = <Login navigate={navigate} />;
          break;
        case "register":
          content = <Register navigate={navigate} />;
          break;
        case "admin":
          content = <Admin navigate={navigate} />;
          break;
        default:
          content = <NotFound navigate={navigate} />;
      }
      
      return (
        <TooltipProvider>
          <AuthProvider>
            <CartProvider>
              <Toaster />
              <Sonner />
              <AppLayout>{content}</AppLayout>
              <ShoppingCart />
            </CartProvider>
          </AuthProvider>
        </TooltipProvider>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
